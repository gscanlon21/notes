{# Uses the Tera templating engine. https://keats.github.io/tera/ #}

{#
    Renders the table of contents.
#}
{% macro render_toc(toc, max_level, exclude='') %}
<ul class="sitemap-list">
	{% for item in toc %}
	{% if item.level < 5 %}
	{% if not exclude or item.id is not containing(exclude) %}
	{% if item.title is not starting_with('"') or item.title is not ending_with('"') %}
	{% if item.title is not starting_with('(') or item.title is not ending_with(')') %}
	{% if item.title is not starting_with('[') or item.title is not ending_with(']') %}
	{% if item.title is not starting_with('_') and item.title is not ending_with(':') %}
		<li>
			<a href="{{ item.permalink }}">{{ item.title }}</a>
			{% if item.children and item.level < max_level %}
				{{ macros::render_toc(toc=item.children, max_level=max_level) }}
			{% endif %}
		</li>
	{% elif item.children and item.level < max_level %}
		{{ macros::render_toc(toc=item.children, max_level=max_level) }}
	{% endif %}
	{% elif item.children and item.level < max_level %}
		{{ macros::render_toc(toc=item.children, max_level=max_level) }}
	{% endif %}
	{% elif item.children and item.level < max_level %}
		{{ macros::render_toc(toc=item.children, max_level=max_level) }}
	{% endif %}
	{% elif item.children and item.level < max_level %}
		{{ macros::render_toc(toc=item.children, max_level=max_level) }}
	{% endif %}
	{% endif %}
	{% endif %}
	{% endfor %}
</ul>
{% endmacro header %}


{#
    Renders a list of pages.
	Warning: Don't use page as the loop variable b/c it already exists in context.
#}
{% macro render_list_links(pages, current_path='', sort=false) %}
{% for item in pages %}
	{% set show_localhost = config.base_url == "http://127.0.0.1:1111" and item.extra.hide_localhost | default(value=false) == false %}
    {% if item.extra.in_sitemap | default(value=true) or show_localhost %}
        {% if item.relative_path == current_path %}
            <li class="current">{{ item.title }}</li>
        {#{% elif item.description %}
            <li>
				<a href="{{ get_url(path="@/" ~ item.relative_path) }}">{{ item.title }}
					<ul><li>{{ item.description }}</li></ul>
				</a>
			</li>#}
		{% else %}
			<li><a href="{{ get_url(path="@/" ~ item.relative_path) }}">{{ item.title }}</a></li>
        {% endif %}
    {% endif %}
{% endfor %}
{% endmacro header %}


{#
    Iterates though the site's pages and subsection and renders nested lists for each.
#}
{% macro render_sitemap(path, open=true, first_pass=true, current_path='') %}
{% set show_localhost = config.base_url == "http://127.0.0.1:1111" %}
{% set section_info = get_section(path=path) %}
{% if first_pass %}
    {% if section_info.pages | length > section_info.pages | filter(attribute="extra.in_sitemap", value=false) | length or show_localhost %}
        <menu class="sitemap-list">
            {{ macros::render_list_links(pages=section_info.pages, current_path=current_path) }}
        </menu>
    {% endif %}
    
    {% for subsection in section_info.subsections | sort %}
        {{ macros::render_sitemap(path=subsection, open=open, first_pass=false) }}
    {% endfor %}
{% elif section_info.extra.in_sitemap | default(value=true) or show_localhost %}
    {% if section_info.transparent %}
        {% for subsection in section_info.subsections | sort %}
            {{ macros::render_sitemap(path=subsection, open=open, first_pass=false) }}
        {% endfor %}
    {% else %}
        <details {% if open %}open{% endif %}>
            <summary><a href="{{ get_url(path="@/" ~ section_info.relative_path) }}">{{ section_info.title }}</a></summary>
            
            <menu class="sitemap-list">
                {{ macros::render_list_links(pages=section_info.pages) }}
        
                {% for subsection in section_info.subsections | sort %}
                    {{ macros::render_sitemap(path=subsection, open=open, first_pass=false) }}
                {% endfor %}
            </menu>
        </details>
    {% endif %}
{% endif %}
{% endmacro header %}


{#
    Iterates though the site's ancestors and renders lists for each.
#}
{% macro render_ancestors(ancestors) %}
<menu class="sitemap-list">
    {% for ancestor in ancestors %}
        {% set ancestor_info = get_section(path=ancestor) %}
        {% if not ancestor_info.transparent and ancestor_info.relative_path != "_index.no.md" %}
            <li><a href="{{ get_url(path="@/" ~ ancestor_info.relative_path) }}">{{ ancestor_info.title }}</a></li>
        {% endif %}
    {% endfor %}
</menu>
{% endmacro header %}


{#
    Renders a page's siblings.
#}
{% macro render_siblings(for) %}
{% if for.ancestors | length > 0 %}
{% set ancestor_section = get_section(path=for.ancestors | last) %}
{% if ancestor_section.pages and ancestor_section.pages | length > ancestor_section.pages | filter(attribute="extra.in_sitemap", value=false) | length + 1 %}
<h3 class="sitemap-title">Siblings</h3>
<nav class="sitemap condensed">
	<menu class="sitemap-list">
		{{ macros::render_list_links(pages=ancestor_section.pages, current_path=for.relative_path) }}

		{# If we want to include sibling sections only: #}
		{#{% for subsection in ancestor_section.subsections | sort %}
			{% set subsection_info = get_section(path=subsection) %}
			<li class="circle">
				<a href="{{ get_url(path="@/" ~ subsection_info.relative_path) }}">{{ subsection_info.title }}</a>
			</li>
		{% endfor %}#}
	</menu>

	{# If we want to include sibling sections and their child items: #}
	{#{{ macros::render_sitemap(path=ancestor_section.relative_path, open=false, current_path=for.relative_path) }}#}
</nav>
{% endif %}
{% endif %}
{% endmacro header %}
